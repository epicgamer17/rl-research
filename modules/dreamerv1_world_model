class DreamerWorldModel(nn.Module):
    """
    Composite World Model class integrating RSSM, Encoder, and Decoders.
    """

    def __init__(self, config: Config, action_dim: int):
        super().__init__()
        self.config = config

        # 1. Encoder
        self.encoder = ConvEncoder(
            input_shape=config.input_shape, depth=32, activation=nn.ReLU()  # (C, H, W)
        )

        # 2. RSSM
        self.rssm = RSSM(
            action_dim=action_dim,
            embed_dim=self.encoder.output_dim,
            stoch=30,
            deter=200,
            hidden=200,
            activation=nn.ELU(),
            discrete=False,
        )

        # 3. Decoders (Observation & Reward)
        feat_size = self.rssm._stoch_size + self.rssm._deter_size

        self.obs_decoder = ConvDecoder(
            feat_size=feat_size,
            depth=32,
            shape=config.input_shape,  # (C, H, W)
            activation=nn.ReLU(),
        )

        self.reward_decoder = DenseDecoder(
            feat_size=feat_size,
            shape=(),  # scalar
            layers=2,
            units=400,
            dist="normal",
            activation=nn.ELU(),
        )

    def forward(self, observation, action, state=None):
        """
        Full step: Encode -> Observe (RSSM) -> Decode
        """
        embed = self.encoder(observation)
        post, prior = self.rssm.observe(embed, action, state)

        # Get features for decoding (posterior)
        feats = self.rssm.get_feat(post)

        image_pred = self.obs_decoder(feats)
        reward_pred = self.reward_decoder(feats)

        return image_pred, reward_pred, post
